name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build and Package
        run: |
          APP_NAME="MacLevel"
          SCHEME="MacLevel"

          # 1. Archive
          xcodebuild archive 
            -project "${APP_NAME}.xcodeproj" 
            -scheme "${SCHEME}" 
            -configuration Release 
            -archivePath "build/${APP_NAME}.xcarchive" 
            CODE_SIGN_IDENTITY="" 
            CODE_SIGNING_REQUIRED=NO 
            CODE_SIGNING_ALLOWED=NO

          # 2. Extract .app
          mkdir -p "dist"
          cp -R "build/${APP_NAME}.xcarchive/Products/Applications/${APP_NAME}.app" "dist/${APP_NAME}.app"

          # 3. Zip
          cd dist
          zip -r "../${APP_NAME}.zip" "${APP_NAME}.app"
          cd ..

          # 4. Calculate SHA256 (Homebrew 업데이트용)
          echo "SHA256=$(shasum -a 256 ${APP_NAME}.zip | awk '{print $1}')" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: MacLevel.zip
          body: |
            ## MacLevel ${{ github.ref_name }}

            ### Homebrew Cask Update Info
            - **Version**: `${{ github.ref_name }}`
            - **SHA256**: `${{ env.SHA256 }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
